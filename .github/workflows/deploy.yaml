# Build API Docker image with build-args (DB + API auth), push to AWS ECR.
# Optionally update a Lambda function to use the new image (step commented out).
#
# Required secrets: AWS_ACCESS_KEY_ID, AWS_SECRET_ACCESS_KEY, DB_PASSWORD, API_BASIC_AUTH_PASSWORD
# Required variables: AWS_REGION, ECR_REPOSITORY, DB_HOST (DB_USER, DB_NAME optional)
# Optional variables: DOCKER_PYTHON_VERSION (3.12), API_BASIC_AUTH_USERNAME, LAMBDA_FUNCTION_NAME

name: Build and push API image to ECR

on:
  push:
    branches: [main]
  workflow_dispatch:

env:
  AWS_REGION: ${{ vars.AWS_REGION || 'us-west-2' }}
  ECR_REPOSITORY: ${{ vars.ECR_REPOSITORY }}

jobs:
  build-and-push:
    runs-on: ubuntu-latest
    environment: prod
    permissions:
      contents: read
      id-token: write

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ env.AWS_REGION }}

      - name: Login to Amazon ECR
        id: login-ecr
        uses: aws-actions/amazon-ecr-login@v2

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Build and push (single platform)
        run: |
          IMAGE="${{ steps.login-ecr.outputs.registry }}/${{ env.ECR_REPOSITORY }}"
          docker buildx build \
            --platform linux/amd64 \
            --provenance=false \
            -f Dockerfile \
            --build-arg PYTHON_VERSION=${{ vars.DOCKER_PYTHON_VERSION || '3.12' }} \
            --build-arg DB_NAME=${{ vars.DB_NAME || 'postgres' }} \
            --build-arg DB_USER=${{ vars.DB_USER || 'postgres' }} \
            --build-arg DB_PASSWORD="${{ secrets.DB_PASSWORD }}" \
            --build-arg DB_HOST=${{ vars.DB_HOST }} \
            --build-arg DB_PORT=${{ vars.DB_PORT || '5432' }} \
            --build-arg API_BASIC_AUTH_USERNAME=${{ vars.API_BASIC_AUTH_USERNAME || '' }} \
            --build-arg API_BASIC_AUTH_PASSWORD="${{ secrets.API_BASIC_AUTH_PASSWORD }}" \
            -t "${IMAGE}:${{ github.sha }}" \
            -t "${IMAGE}:latest" \
            .

      - name: Push image to ECR
        run: |
          docker push ${{ steps.login-ecr.outputs.registry }}/${{ env.ECR_REPOSITORY }}:${{ github.sha }}
          docker push ${{ steps.login-ecr.outputs.registry }}/${{ env.ECR_REPOSITORY }}:latest

      # Uncomment to update Lambda to use the new image (Lambda must be configured for container image).
      # - name: Update Lambda function with new image
      #   run: |
      #     aws lambda update-function-code \
      #       --function-name ${{ vars.LAMBDA_FUNCTION_NAME }} \
      #       --image-uri ${{ env.ECR_REPOSITORY }}:${{ github.sha }} \
      #       --region ${{ env.AWS_REGION }}
      # - name: Wait for Lambda update to complete
      #   run: |
      #     aws lambda wait function-updated \
      #       --function-name ${{ vars.LAMBDA_FUNCTION_NAME }} \
      #       --region ${{ env.AWS_REGION }}
